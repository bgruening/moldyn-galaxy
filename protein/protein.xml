<tool id="protein" name="A simple simulation of a protein." version="0.1.0">
    <!-- Note: this wrapper is (for now) based on Justin Lemkul's GROMACS tutorial which can be found here: http://www.bevanlab.biochem.vt.edu/Pages/Personal/justin/gmx-tutorials/lysozyme/ -->
    <requirements>
        <requirement type="package">gromacs</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[

        ln -s $ions ./ions.mdp &&
        ln -s $nvt ./nvt.mdp &&
        ln -s $npt ./npt.mdp &&
        ln -s $md ./md.mdp &&
        ln -s $minim ./minim.mdp &&
        ln -s $pdb_input ./pdb_input.pdb &&

        /usr/local/gromacs/bin/gmx pdb2gmx -f ./pdb_input.pdb -o processed.gro -p topol.top -i posres.itp -water $h2o -ff $ff -${ignore_h}ignh &&

        /usr/local/gromacs/bin/gmx editconf -f processed.gro -o newbox.gro -c -d $box_d -bt $box_type &&

        /usr/local/gromacs/bin/gmx solvate -cp newbox.gro -cs spc216.gro -o solv.gro -p topol.top &&

        /usr/local/gromacs/bin/gmx grompp -f ./ions.mdp -c solv.gro -p topol.top -o ions.tpr -maxwarn 1 &&
        echo 'SOL' | /usr/local/gromacs/bin/gmx genion -s ions.tpr -o solv_ions.gro -p topol.top -pname NA -nname CL -neutral &&
    
        /usr/local/gromacs/bin/gmx grompp -f ./minim.mdp -c solv_ions.gro -p topol.top -o em.tpr &&
        /usr/local/gromacs/bin/gmx mdrun -deffnm em &&

        /usr/local/gromacs/bin/gmx grompp -f ./nvt.mdp -c em.gro -r em.gro -p topol.top -o nvt.tpr &&
        /usr/local/gromacs/bin/gmx mdrun -deffnm nvt &&

        /usr/local/gromacs/bin/gmx grompp -f ./npt.mdp -c nvt.gro -r em.gro -t nvt.cpt -p topol.top -o npt.tpr &&
        /usr/local/gromacs/bin/gmx mdrun -deffnm npt &&

        /usr/local/gromacs/bin/gmx grompp -f ./md.mdp -c npt.gro -t npt.cpt -p topol.top -o md_0_1.tpr &&
        /usr/local/gromacs/bin/gmx mdrun -deffnm md_0_1 &&

        cp md_0_1.trr $output1
    ]]></command>

        <configfiles>
            <!-- .mdp files which are needed for the gromacs simulation -->
            <configfile name="ions">
; ions.mdp - used as input into grompp to generate ions.tpr
; Parameters describing what to do, when to stop and what to save
integrator	= steep		; Algorithm (steep = steepest descent minimization)
emtol		= 1000.0  	; Stop minimization when the maximum force is less than 1000.0 kJ/mol/nm
emstep      = 0.01      ; Energy step size
nsteps		= 50	  	; Maximum number of (minimization) steps to perform

; Parameters describing how to find the neighbors of each atom and how to calculate the interactions
nstlist		    = 1		    ; Frequency to update the neighbor list and long range forces
cutoff-scheme   = Verlet
ns_type		    = grid		; Method to determine neighbor list (simple, grid)
coulombtype	    = PME		; Treatment of long range electrostatic interactions
rcoulomb	    = 1.0		; Short-range electrostatic cut-off
rvdw		    = 1.0		; Short-range Van der Waals cut-off
pbc		        = xyz 		; Periodic Boundary Conditions (yes/no)
            </configfile>
            <configfile name="minim">
; minim.mdp - used as input into grompp to generate em.tpr
integrator	= steep		; Algorithm (steep = steepest descent minimization)
emtol		= 1000.0  	; Stop minimization when the maximum force is less than 1000.0 kJ/mol/nm
emstep      = 0.01      ; Energy step size
nsteps		= 50	  	; Maximum number of (minimization) steps to perform

; Parameters describing how to find the neighbors of each atom and how to calculate the interactions
nstlist		    = 1		    ; Frequency to update the neighbor list and long range forces
cutoff-scheme   = Verlet
ns_type		    = grid		; Method to determine neighbor list (simple, grid)
coulombtype	    = PME		; Treatment of long range electrostatic interactions
rcoulomb	    = 1.0		; Short-range electrostatic cut-off
rvdw		    = 1.0		; Short-range Van der Waals cut-off
pbc		        = xyz 		; Periodic Boundary Conditions (yes/no)
            </configfile>
            <configfile name="nvt">
title		= OPLS Lysozyme NVT equilibration 
define		= -DPOSRES	; position restrain the protein
; Run parameters
integrator	= md		; leap-frog integrator
nsteps		= 50		; 2 * 50000 = 100 ps
dt		    = 0.002		; 2 fs
; Output control
nstxout		= 500		; save coordinates every 1.0 ps
nstvout		= 500		; save velocities every 1.0 ps
nstenergy	= 500		; save energies every 1.0 ps
nstlog		= 500		; update log file every 1.0 ps
; Bond parameters
continuation	        = no		; first dynamics run
constraint_algorithm    = lincs	    ; holonomic constraints 
constraints	            = all-bonds	; all bonds (even heavy atom-H bonds) constrained
lincs_iter	            = 1		    ; accuracy of LINCS
lincs_order	            = 4		    ; also related to accuracy
; Neighborsearching
cutoff-scheme   = Verlet
ns_type		    = grid		; search neighboring grid cells
nstlist		    = 10		; 20 fs, largely irrelevant with Verlet
rcoulomb	    = 1.0		; short-range electrostatic cutoff (in nm)
rvdw		    = 1.0		; short-range van der Waals cutoff (in nm)
; Electrostatics
coulombtype	    = PME	; Particle Mesh Ewald for long-range electrostatics
pme_order	    = 4		; cubic interpolation
fourierspacing	= 0.16	; grid spacing for FFT
; Temperature coupling is on
tcoupl		= V-rescale	            ; modified Berendsen thermostat
tc-grps		= Protein Non-Protein	; two coupling groups - more accurate
tau_t		= 0.1	  0.1           ; time constant, in ps
ref_t		= 300 	  300           ; reference temperature, one for each group, in K
; Pressure coupling is off
pcoupl		= no 		; no pressure coupling in NVT
; Periodic boundary conditions
pbc		= xyz		    ; 3-D PBC
; Dispersion correction
DispCorr	= EnerPres	; account for cut-off vdW scheme
; Velocity generation
gen_vel		= yes		; assign velocities from Maxwell distribution
gen_temp	= 300		; temperature for Maxwell distribution
gen_seed	= -1		; generate a random seed

            </configfile>
            <configfile name="npt">
title		= OPLS Lysozyme NPT equilibration 
define		= -DPOSRES	; position restrain the protein
; Run parameters
integrator	= md		; leap-frog integrator
nsteps		= 50		; 2 * 50000 = 100 ps
dt		    = 0.002		; 2 fs
; Output control
nstxout		= 500		; save coordinates every 1.0 ps
nstvout		= 500		; save velocities every 1.0 ps
nstenergy	= 500		; save energies every 1.0 ps
nstlog		= 500		; update log file every 1.0 ps
; Bond parameters
continuation	        = yes		; Restarting after NVT 
constraint_algorithm    = lincs	    ; holonomic constraints 
constraints	            = all-bonds	; all bonds (even heavy atom-H bonds) constrained
lincs_iter	            = 1		    ; accuracy of LINCS
lincs_order	            = 4		    ; also related to accuracy
; Neighborsearching
cutoff-scheme   = Verlet
ns_type		    = grid		; search neighboring grid cells
nstlist		    = 10	    ; 20 fs, largely irrelevant with Verlet scheme
rcoulomb	    = 1.0		; short-range electrostatic cutoff (in nm)
rvdw		    = 1.0		; short-range van der Waals cutoff (in nm)
; Electrostatics
coulombtype	    = PME		; Particle Mesh Ewald for long-range electrostatics
pme_order	    = 4		    ; cubic interpolation
fourierspacing	= 0.16		; grid spacing for FFT
; Temperature coupling is on
tcoupl		= V-rescale	            ; modified Berendsen thermostat
tc-grps		= Protein Non-Protein	; two coupling groups - more accurate
tau_t		= 0.1	  0.1	        ; time constant, in ps
ref_t		= 300 	  300	        ; reference temperature, one for each group, in K
; Pressure coupling is on
pcoupl		        = Parrinello-Rahman	    ; Pressure coupling on in NPT
pcoupltype	        = isotropic	            ; uniform scaling of box vectors
tau_p		        = 2.0		            ; time constant, in ps
ref_p		        = 1.0		            ; reference pressure, in bar
compressibility     = 4.5e-5	            ; isothermal compressibility of water, bar^-1
refcoord_scaling    = com
; Periodic boundary conditions
pbc		= xyz		; 3-D PBC
; Dispersion correction
DispCorr	= EnerPres	; account for cut-off vdW scheme
; Velocity generation
gen_vel		= no		; Velocity generation is off 

            </configfile>
            <configfile name="md">
title		= OPLS Lysozyme MD simulation 
; Run parameters
integrator	= md		; leap-frog integrator
nsteps		= $md_steps	; 2 * 500000 = 1000 ps (1 ns)
dt		    = $step_length		; 2 fs
; Output control
nstxout		        = 5000		; save coordinates every 10.0 ps
nstvout		        = 5000		; save velocities every 10.0 ps
nstenergy	        = 5000		; save energies every 10.0 ps
nstlog		        = 5000		; update log file every 10.0 ps
nstxout-compressed  = 5000      ; save compressed coordinates every 10.0 ps
                                ; nstxout-compressed replaces nstxtcout
compressed-x-grps   = System    ; replaces xtc-grps
; Bond parameters
continuation	        = yes		; Restarting after NPT 
constraint_algorithm    = lincs	    ; holonomic constraints 
constraints	            = all-bonds	; all bonds (even heavy atom-H bonds) constrained
lincs_iter	            = 1		    ; accuracy of LINCS
lincs_order	            = 4		    ; also related to accuracy
; Neighborsearching
cutoff-scheme   = Verlet
ns_type		    = grid		; search neighboring grid cells
nstlist		    = 10	    ; 20 fs, largely irrelevant with Verlet scheme
rcoulomb	    = 1.0		; short-range electrostatic cutoff (in nm)
rvdw		    = 1.0		; short-range van der Waals cutoff (in nm)
; Electrostatics
coulombtype	    = PME		; Particle Mesh Ewald for long-range electrostatics
pme_order	    = 4		    ; cubic interpolation
fourierspacing	= 0.16		; grid spacing for FFT
; Temperature coupling is on
tcoupl		= V-rescale	            ; modified Berendsen thermostat
tc-grps		= Protein Non-Protein	; two coupling groups - more accurate
tau_t		= 0.1	  0.1	        ; time constant, in ps
ref_t		= 300 	  300	        ; reference temperature, one for each group, in K
; Pressure coupling is on
pcoupl		        = Parrinello-Rahman	    ; Pressure coupling on in NPT
pcoupltype	        = isotropic	            ; uniform scaling of box vectors
tau_p		        = 2.0		            ; time constant, in ps
ref_p		        = 1.0		            ; reference pressure, in bar
compressibility     = 4.5e-5	            ; isothermal compressibility of water, bar^-1
; Periodic boundary conditions
pbc		= xyz		; 3-D PBC
; Dispersion correction
DispCorr	= EnerPres	; account for cut-off vdW scheme
; Velocity generation
gen_vel		= no		; Velocity generation is off 

            </configfile>
        </configfiles>

    <inputs>
        <param name="pdb_input" type="data" format="pdb" label="PDB input file."/>
        <param name="h2o" type="select" label="Water model">
            <option value="spce" selected="true">SPCE</option>
            <!-- More here -->
        </param>
        <param name="ff" type="select" label="Force field">
            <option value="oplsaa" selected="true">OPLS/AA</option>
            <option value="CHARMM">CHARMM</option>
            <!-- More here -->
        </param>
        <param name="ignore_h" type="boolean" label="Ignore hydrogens" truevalue="" falsevalue="no" help="ignore hydrogens" />
        <param name="box_d" type="float" label="Box dimensions" value="0.0" min="0.0" max="10.0" help="Box dimensions" />
        <param name="box_type" type="select" label="Box type">
            <option value="cubic">Cubic</option>
            <option value="icosahedral" selected="true">Icosahedral</option>
            <!-- More here -->
        </param>

        <!-- Variables for .mdp files -->
        <param name="md_steps" type="integer" label="Number of steps for the MD simulation" value="0" min="0" max="1000000" help="MD steps" />
        <param name="step_length" type="float" label="Step length in ps" value="0" min="0.0001" max="1.0" help="Step length in ps." />
        
    </inputs>
    <outputs>
        <data name="output1" format="trr"/>
    </outputs>
    <tests>
        <test>
            <param name="pdb_input" value="1AKI.pdb" />
            <param name="h2o" value="spce" />
            <param name="ff" value="oplsaa" />
            <param name="ignore_h" value="no" />
            <param name="box_d" value="1.0" />
            <param name="box_type" value="cubic" />
            <param name="step_length" value="0.002"/>
            <param name="md_steps" value="500"/>

            <output name="output1" file="md_0_1.trr">

            </output>
        </test>
    </tests>
    <help><![CDATA[
        A simple simulation of a protein.
    ]]></help>

    <citations>
        <citation type="bibtex">
@article{ABRAHAM201519,
title = "GROMACS: High performance molecular simulations through multi-level parallelism from laptops to supercomputers",
journal = "SoftwareX",
volume = "1-2",
pages = "19 - 25",
year = "2015",
issn = "2352-7110",
doi = "https://doi.org/10.1016/j.softx.2015.06.001",
url = "http://www.sciencedirect.com/science/article/pii/S2352711015000059",
author = "Mark James Abraham and Teemu Murtola and Roland Schulz and Szilárd Páll and Jeremy C. Smith and Berk Hess and Erik Lindahl",
keywords = "Molecular dynamics, GPU, SIMD, Free energy"
}</citation>
    </citations>
</tool>